{% extends 'layouts/index.html' %}
{% load static %}

{% block title %}Додати пристрій{% endblock %}

{% block content %}
<div class="device-create-page">
    <div class="device-create-container">
        <div class="header">
            <button class="back-btn" onclick="history.back()">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.42-1.41L7.83 13H20v-2z"/>
                </svg>
                Назад
            </button>
            <h1 class="title">Додати пристрій</h1>
            <button class="next-btn" id="nextBtn" disabled>
                <span id="nextBtnText">Далі</span>
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M4 13h12.17l-5.59 5.59L12 20l8-8-8-8-1.41 1.41L16.17 11H4v2z"/>
                </svg>
            </button>
        </div>

        <!-- Step 1: Device Configuration -->
        <div class="step-content" id="step1">
            <div class="form-container">
                <h2 class="form-title">Створити VPN пристрій</h2>
                
                <div class="info-box">
                    <svg class="info-icon" width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,17A1.5,1.5 0 0,1 10.5,15.5A1.5,1.5 0 0,1 12,14A1.5,1.5 0 0,1 13.5,15.5A1.5,1.5 0 0,1 12,17M12,10.5A1.5,1.5 0 0,1 10.5,9A1.5,1.5 0 0,1 12,7.5A1.5,1.5 0 0,1 13.5,9A1.5,1.5 0 0,1 12,10.5Z"/>
                    </svg>
                    <span>Вам потрібно налаштувати WireGuard VPN на вашому пристрої. Відвідайте <a href="#" class="documentation-link">документацію</a>, якщо не знаєте як це зробити.</span>
                </div>

                <form id="deviceForm" method="post">
                    {% csrf_token %}
                    {% if request.user.is_superuser and user_id %}
                        <input type="hidden" id="user_id" name="user_id" value="{{ user_id }}">
                    {% endif %}
                    <div class="form-group">
                        <label for="device_name">Назва пристрою:</label>
                        <input type="text" id="device_name" name="name" class="form-input" placeholder="Введіть назву пристрою" required>
                    </div>

                    <div class="form-group">
                        <label for="location_id">Локація:</label>
                        <select id="location_id" name="location_id" class="form-input" required>
                            <option value="">Оберіть локацію</option>
                            {% for location in locations %}
                                <option value="{{ location.id }}">{{ location.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
        </div>

        <!-- Step 2: QR Code and Download -->
        <div class="step-content" id="step2" style="display: none;">
            <div class="config-container">
                <h2 class="form-title">Конфігурація пристрою</h2>
                
                <div class="config-sections">
                    <div class="qr-section">
                        <h3>QR код</h3>
                        <div class="qr-code-container">
                            <div id="qr-code"></div>
                        </div>
                        <p class="qr-description">Відскануйте цей QR код за допомогою WireGuard додатку</p>
                    </div>

                    <div class="download-section">
                        <h3>Файл конфігурації</h3>
                        <button class="download-btn" id="downloadBtn">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z"/>
                            </svg>
                            Завантажити конфігурацію
                        </button>
                        <p class="download-description">Завантажте файл конфігурації для ручного імпорту</p>
                    </div>
                </div>

                <div class="device-info">
                    <h3>Інформація про пристрій</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Назва пристрою:</span>
                            <span class="info-value" id="device-name-display"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">IP адреса:</span>
                            <span class="info-value" id="device-ip-display"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Публічний ключ:</span>
                            <span class="info-value" id="device-key-display"></span>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="back-step-btn" id="backStepBtn">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.42-1.41L7.83 13H20v-2z"/>
                        </svg>
                        Назад
                    </button>
                    <button class="finish-btn" id="finishBtn">
                        Завершити
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Якщо є параметр location_id в URL, вибираємо його автоматично
const urlParams = new URLSearchParams(window.location.search);
const locationId = urlParams.get('location_id');
if (locationId) {
    const locationSelect = document.getElementById('location_id');
    if (locationSelect) {
        locationSelect.value = locationId;
    }
}

// Додаткова перевірка для кнопки
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded');
    const nextBtn = document.getElementById('nextBtn');
    const deviceName = document.getElementById('device_name');
    const locationId = document.getElementById('location_id');
    
    console.log('nextBtn:', nextBtn);
    console.log('deviceName:', deviceName);
    console.log('locationId:', locationId);
    
    function checkForm() {
        const nameValue = deviceName ? deviceName.value.trim() : '';
        const locationValue = locationId ? locationId.value : '';
        
        console.log('Name:', nameValue, 'Location:', locationValue);
        
        if (nameValue && locationValue && nextBtn) {
            nextBtn.disabled = false;
            nextBtn.classList.remove('disabled');
            console.log('Button enabled');
        } else if (nextBtn) {
            nextBtn.disabled = true;
            nextBtn.classList.add('disabled');
            console.log('Button disabled');
        }
    }
    
    if (deviceName) deviceName.addEventListener('input', checkForm);
    if (locationId) locationId.addEventListener('change', checkForm);
    
    // Початкова перевірка
    checkForm();
});
</script>

<script src="{% static 'js/device-create.js' %}"></script>
{% endblock %}
