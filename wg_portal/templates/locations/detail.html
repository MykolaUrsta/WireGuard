{% extends 'layouts/index.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">Огляд локації: {{ location.name }}</h2>
        <a href="{% url 'locations:edit' location.pk %}" class="btn btn-outline-primary">
            <i class="bi bi-gear"></i> Налаштування локації
        </a>
    </div>
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <div class="mb-2"><i class="bi bi-person fs-2"></i></div>
                    <div class="fw-bold">Активних користувачів зараз</div>
                    <div class="fs-4 online-users-counter">0</div>
                    <div class="small text-muted">Всього пристроїв: <span class="total-user-devices">0</span></div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <div class="mb-2"><i class="bi bi-laptop fs-2"></i></div>
                    <div class="fw-bold">Активних пристроїв зараз</div>
                    <div class="fs-4 online-devices-counter">0</div>
                    <div class="small text-muted">Всього: <span class="total-devices">0</span></div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <div class="mb-2"><i class="bi bi-person fs-2"></i></div>
                    <div class="fw-bold">Користувачів за 1 год</div>
                    <div class="fs-4 users-last-hour-counter">0</div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <div class="mb-2"><i class="bi bi-laptop fs-2"></i></div>
                    <div class="fw-bold">Пристроїв за 1 год</div>
                    <div class="fs-4 devices-last-hour-counter">0</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <div class="fw-bold">Всього передано:</div>
                    <div class="d-flex justify-content-center align-items-center">
                        <span class="text-primary me-2">In: <span class="total-bytes-received">0 B</span></span>
                        <span class="text-danger">Out: <span class="total-bytes-sent">0 B</span></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="online-users-section" class="mb-4" style="display:none;">
        <h4>Підключені користувачі</h4>
        <div class="row align-items-stretch" id="online-users-list" style="min-height: 200px;">
            <!-- Динамічно вставляються онлайн-користувачі -->
        </div>
        <div id="no-online-users" class="text-center text-muted py-5" style="display:none; font-size: 1.2rem;">Немає підключень</div>
    </div>
    <div id="online-users-section" class="mb-4" style="display:none;">
        <h4>Підключені користувачі</h4>
        <div class="row" id="online-users-list">
            <!-- Динамічно вставляються онлайн-користувачі -->
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// let activityChart = null; // видалено глобальний графік
let peerCharts = {};

function renderOnlineUsers(devices) {
    const container = document.getElementById('online-users-list');
    container.innerHTML = '';
    let anyOnline = false;
    devices.forEach(device => {
        if (!device.is_online) return;
        anyOnline = true;
        // Fallbacks for user info (may be missing in API)
        let username = (device.user && device.user.username) ? device.user.username : (device.username || '');
        let fullName = (device.user && device.user.full_name) ? device.user.full_name : (device.full_name || username);
        let avatar = username ? username.slice(0,2).toUpperCase() : '?';
        const card = document.createElement('div');
        card.className = 'col-md-6 mb-3 d-flex align-items-stretch';
        card.innerHTML = `
            <div class="card h-100">
                <div class="card-body d-flex align-items-center h-100">
                    <div class="me-3">
                        <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width:48px;height:48px;font-size:1.5rem;">
                            ${avatar}
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-bold">${fullName}</div>
                        <div class="text-muted small">${device.public_key || ''}</div>
                        <div class="text-muted small">Пристрій: ${device.name || ''}</div>
                        <div class="d-flex align-items-center mt-2">
                            <span class="text-primary me-3" id="bytes-received-${device.id}">Отримано: ${device.bytes_sent_human || '0 B'}</span>
                            <span class="text-danger" id="bytes-sent-${device.id}">Відправлено: ${device.bytes_received_human || '0 B'}</span>
                        </div>
                        <div class="mt-2">
                            <canvas id="peerChart-${device.id}" height="40"></canvas>
                        </div>
                    </div>
                    <div class="ms-3 text-end">
                        <div class="connection-status" id="connection-status-${device.id}">
                            <span class="text-success small"><i class="bi bi-circle-fill"></i> Підключено</span>
                        </div>
                        <div class="text-muted small" id="connection-time-${device.id}"></div>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(card);
    });
    document.getElementById('online-users-section').style.display = anyOnline ? '' : 'none';
    document.getElementById('no-online-users').style.display = anyOnline ? 'none' : '';
}


function updatePeerCharts(devices) {
    devices.forEach(device => {
        if (!device.is_online) return;
        fetch(`/locations/api/peer-history/${device.id}/?from=` + encodeURIComponent(new Date(Date.now()-60*60*1000).toISOString()))
            .then(r => r.json())
            .then(res => {
                const labels = res.history.map(h => (new Date(h.timestamp)).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
                const outData = res.history.map(h => h.bytes_received/1024/1024);
                const inData = res.history.map(h => h.bytes_sent/1024/1024);
                const ctx = document.getElementById(`peerChart-${device.id}`).getContext('2d');
                if (!peerCharts[device.id]) {
                    peerCharts[device.id] = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Відправлено',
                                    data: outData,
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                    fill: false,
                                    tension: 0.2
                                },
                                {
                                    label: 'Отримано',
                                    data: inData,
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                    fill: false,
                                    tension: 0.2
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { display: true } },
                            scales: { x: { display: true }, y: { display: true } }
                        }
                    });
                } else {
                    peerCharts[device.id].data.labels = labels;
                    peerCharts[device.id].data.datasets[0].data = outData;
                    peerCharts[device.id].data.datasets[1].data = inData;
                    peerCharts[device.id].update();
                }
            });
    });
}

function updateLocationStats() {
    fetch(`/locations/api/location-stats/{{ location.id }}/`)
        .then(response => response.json())
        .then(data => {
            // counters
            document.querySelector('.online-users-counter').textContent = data.online_users || data.online_devices || 0;
            document.querySelector('.online-devices-counter').textContent = data.online_devices || 0;
            document.querySelector('.users-last-hour-counter').textContent = data.users_last_hour || 0;
            document.querySelector('.devices-last-hour-counter').textContent = data.devices_last_hour || 0;
            document.querySelectorAll('.total-bytes-received').forEach(el => el.textContent = data.total_bytes_received_human || '0 B');
            document.querySelectorAll('.total-bytes-sent').forEach(el => el.textContent = data.total_bytes_sent_human || '0 B');
            document.querySelector('.total-user-devices').textContent = data.total_user_devices || 0;
            document.querySelector('.total-devices').textContent = data.total_devices || 0;

            // online users/devices
            if (data.devices) {
                renderOnlineUsers(data.devices);
                updatePeerCharts(data.devices);
                // Таймери підключення та live bytes update
                data.devices.forEach(device => {
                    if (!device.is_online) return;
                    // Update bytes live (поміняти місцями)
                    const sent = document.getElementById(`bytes-sent-${device.id}`);
                    const recv = document.getElementById(`bytes-received-${device.id}`);
                    if (sent) sent.textContent = `Відправлено: ${device.bytes_received_human || '0 B'}`;
                    if (recv) recv.textContent = `Отримано: ${device.bytes_sent_human || '0 B'}`;
                    // Connection timer
                    const timeElement = document.getElementById(`connection-time-${device.id}`);
                    if (timeElement && device.connected_at) {
                        if (!timeElement.dataset.timerStarted || timeElement.dataset.timerStarted !== device.connected_at) {
                            timeElement.dataset.timerStarted = device.connected_at;
                            if (timeElement._interval) clearInterval(timeElement._interval);
                            let start = new Date(device.connected_at);
                            function updateTimer() {
                                let now = new Date();
                                let diff = Math.floor((now - start) / 1000);
                                let h = Math.floor(diff / 3600);
                                let m = Math.floor((diff % 3600) / 60);
                                let s = diff % 60;
                                timeElement.textContent = h > 0 ? `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}` : `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                            }
                            updateTimer();
                            timeElement._interval = setInterval(updateTimer, 1000);
                        }
                    }
                });
            }
        });
}


setInterval(updateLocationStats, 1000);

document.addEventListener('DOMContentLoaded', function() {
    updateLocationStats();
});
</script>
{% endblock %}