{% extends 'layouts/index.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">Огляд локації</h2>
        <a href="#" class="btn btn-outline-primary">Редагувати налаштування локації</a>
    </div>
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <div class="mb-2"><i class="bi bi-person fs-2"></i></div>
                    <div class="fw-bold">Активних користувачів зараз</div>
                    <div class="fs-4">{{ online_devices }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <div class="mb-2"><i class="bi bi-laptop fs-2"></i></div>
                    <div class="fw-bold">Активних пристроїв зараз</div>
                    <div class="fs-4">{{ online_devices }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <div class="mb-2"><i class="bi bi-person fs-2"></i></div>
                    <div class="fw-bold">Користувачів за 1 год</div>
                    <div class="fs-4">{{ online_devices }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <div class="mb-2"><i class="bi bi-laptop fs-2"></i></div>
                    <div class="fw-bold">Пристроїв за 1 год</div>
                    <div class="fs-4">{{ online_devices }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <div class="fw-bold">Всього передано:</div>
                    <div class="d-flex justify-content-center align-items-center">
                        <span class="text-primary me-2">In: {{ location.traffic_in|filesizeformat }}</span>
                        <span class="text-danger">Out: {{ location.traffic_out|filesizeformat }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <div class="fw-bold mb-2">Активність за 1 год</div>
                    <canvas id="activityChart" height="80"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <div class="fw-bold mb-2">Всього передано:</div>
                    <div class="d-flex justify-content-between">
                        <span class="text-primary">{{ location.traffic_in|filesizeformat }}</span>
                        <span class="text-danger">{{ location.traffic_out|filesizeformat }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="mb-4">
        <h4>Підключені користувачі</h4>
        <div class="row">
            {% for device in location.devices.all %}
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-body d-flex align-items-center">
                        <div class="me-3">
                            <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width:48px;height:48px;font-size:1.5rem;">
                                {{ device.user.username|slice:":2"|upper }}
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-bold">{{ device.user.get_full_name|default:device.user.username }}</div>
                            <div class="text-muted small">{{ device.public_key }}</div>
                            <div class="text-muted small">Пристрій: {{ device.name }}</div>
                            <div class="d-flex align-items-center mt-2">
                                <span class="text-primary me-3">Отримано: {{ device.bytes_received|filesizeformat }}</span>
                                <span class="text-danger">Відправлено: {{ device.bytes_sent|filesizeformat }}</span>
                            </div>
                            <div class="mt-2">
                                <canvas id="peerChart-{{ device.id }}" height="40"></canvas>
                            </div>
                        </div>
                        <div class="ms-3 text-end">
                            <div class="text-success small">Підключено</div>
                            <div class="text-muted small">{{ device.last_handshake|timesince }} тому</div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('activityChart').getContext('2d');
const locationId = "{{ location.id }}";
fetch(`/wireguard_management/api/location-history/${locationId}/?from=` + encodeURIComponent(new Date(Date.now()-60*60*1000).toISOString()))
  .then(r => r.json())
  .then(res => {
    const labels = res.history.map(h => (new Date(h.timestamp)).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
    const inData = res.history.map(h => h.bytes_received/1024/1024);
    const outData = res.history.map(h => h.bytes_sent/1024/1024);
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Отримано',
            data: inData,
            backgroundColor: 'rgba(54, 162, 235, 0.5)'
          },
          {
            label: 'Відправлено',
            data: outData,
            backgroundColor: 'rgba(255, 99, 132, 0.5)'
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: { display: true },
          y: { display: true }
        }
      }
    });
  });
</script>
<script>
// Для кожного пристрою будуємо графік активності
{% for device in location.devices.all %}
fetch(`/wireguard_management/api/peer-history/{{ device.id }}/?from=` + encodeURIComponent(new Date(Date.now()-60*60*1000).toISOString()))
  .then(function(r) { return r.json(); })
  .then(function(res) {
    var labels = res.history.map(function(h) { return (new Date(h.timestamp)).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); });
    var inData = res.history.map(function(h) { return h.bytes_received/1024/1024; });
    var outData = res.history.map(function(h) { return h.bytes_sent/1024/1024; });
    var ctx = document.getElementById('peerChart-{{ device.id }}').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'In',
            data: inData,
            backgroundColor: 'rgba(54, 162, 235, 0.5)'
          },
          {
            label: 'Out',
            data: outData,
            backgroundColor: 'rgba(255, 99, 132, 0.5)'
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: { display: false },
          y: { display: false }
        }
      }
    });
  });
{% endfor %}
</script>
{% endblock %}
