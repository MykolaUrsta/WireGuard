{% extends 'base.html' %}
{% load static %}

{% block title %}WireGuard Dashboard{% endblock %}

{% block extra_css %}
<style>
.dashboard-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    text-align: center;
}

.stat-number {
    font-size: 2.5em;
    font-weight: bold;
    margin: 10px 0;
}

.stat-label {
    font-size: 0.9em;
    opacity: 0.9;
}

.peers-section {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.section-title {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 20px;
}

.section-title h2 {
    color: #374151;
    margin: 0;
    font-size: 1.5em;
}

.btn-primary {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    border: none;
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    color: white;
}

.peers-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.peers-table th,
.peers-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #e5e7eb;
}

.peers-table th {
    background: #f8fafc;
    font-weight: 600;
    color: #374151;
    text-transform: uppercase;
    font-size: 0.8em;
    letter-spacing: 0.5px;
}

.peers-table tr:hover {
    background: #f8fafc;
}

.status-online {
    color: #10b981;
    font-weight: bold;
}

.status-offline {
    color: #ef4444;
    font-weight: bold;
}

.traffic-stats {
    font-family: monospace;
    font-size: 0.9em;
}

.action-buttons {
    display: flex;
    gap: 10px;
}

.btn-sm {
    padding: 5px 10px;
    font-size: 0.8em;
    border-radius: 6px;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-success {
    background: #10b981;
    color: white;
}

.btn-warning {
    background: #f59e0b;
    color: white;
}

.btn-danger {
    background: #ef4444;
    color: white;
}

.btn-sm:hover {
    transform: translateY(-1px);
    color: white;
}

.empty-state {
    text-align: center;
    padding: 40px;
    color: #6b7280;
}

.empty-state .icon {
    font-size: 4em;
    margin-bottom: 20px;
}

.quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.action-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    text-decoration: none;
    color: #374151;
    transition: all 0.2s;
}

.action-card:hover {
    border-color: #6366f1;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    color: #6366f1;
}

.action-icon {
    font-size: 2.5em;
    margin-bottom: 10px;
    display: block;
}

@media (max-width: 768px) {
    .dashboard-container {
        padding: 10px;
    }
    
    .stat-card {
        padding: 20px;
    }
    
    .peers-table {
        font-size: 0.9em;
    }
    
    .action-buttons {
        flex-direction: column;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <h1>üõ°Ô∏è WireGuard Dashboard</h1>
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">üîó –í–∞—à—ñ –∑'—î–¥–Ω–∞–Ω–Ω—è</div>
            <div class="stat-number">{{ user_peers.count }}</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-label">üåê –î–æ—Å—Ç—É–ø–Ω—ñ –º–µ—Ä–µ–∂—ñ</div>
            <div class="stat-number">{{ total_networks }}</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-label">üñ•Ô∏è –ê–∫—Ç–∏–≤–Ω—ñ —Å–µ—Ä–≤–µ—Ä–∏</div>
            <div class="stat-number">{{ active_servers }}</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-label">üìä –í–∞—à —Ç—Ä–∞—Ñ—ñ–∫</div>
            <div class="stat-number">
                {% if user.get_upload_mb and user.get_download_mb %}
                    {{ user.get_upload_mb|add:user.get_download_mb|floatformat:1 }} MB
                {% else %}
                    0 MB
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- –í–∞—à—ñ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è -->
    <div class="peers-section">
        <div class="section-title">
            <h2>üîë –í–∞—à—ñ WireGuard –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó</h2>
            <a href="{% url 'wireguard_management:create_config' %}" class="btn-primary">
                ‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é
            </a>
        </div>
        
        {% if user_peers %}
            <table class="peers-table">
                <thead>
                    <tr>
                        <th>–ù–∞–∑–≤–∞</th>
                        <th>IP –∞–¥—Ä–µ—Å–∞</th>
                        <th>–°–µ—Ä–≤–µ—Ä</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–¢—Ä–∞—Ñ—ñ–∫</th>
                        <th>–î—ñ—ó</th>
                    </tr>
                </thead>
                <tbody>
                    {% for peer in user_peers %}
                    <tr>
                        <td><strong>{{ peer.name }}</strong></td>
                        <td><code>{{ peer.ip_address }}</code></td>
                        <td>{{ peer.server.name }}</td>
                        <td>
                            {% if peer.is_online %}
                                <span class="status-online">üü¢ –û–Ω–ª–∞–π–Ω</span>
                            {% else %}
                                <span class="status-offline">üî¥ –û—Ñ–ª–∞–π–Ω</span>
                            {% endif %}
                        </td>
                        <td class="traffic-stats">
                            ‚Üë {{ peer.get_sent_mb }} MB<br>
                            ‚Üì {{ peer.get_received_mb }} MB
                        </td>
                        <td>
                            <div class="action-buttons">
                                <a href="{% url 'wireguard_management:download_config' %}?peer_id={{ peer.id }}" 
                                   class="btn-sm btn-success">üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</a>
                                <button onclick="showQRCode({{ peer.id }})" 
                                        class="btn-sm btn-warning">üì± QR –∫–æ–¥</button>
                                <form method="post" action="{% url 'wireguard_management:delete_config' %}" 
                                      style="display: inline;" onsubmit="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ?')">
                                    {% csrf_token %}
                                    <input type="hidden" name="peer_id" value="{{ peer.id }}">
                                    <button type="submit" class="btn-sm btn-danger">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="empty-state">
                <div class="icon">üîê</div>
                <h3>–£ –≤–∞—Å –Ω–µ–º–∞—î WireGuard –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π</h3>
                <p>–°—Ç–≤–æ—Ä—ñ—Ç—å —Å–≤–æ—é –ø–µ—Ä—à—É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –¥–ª—è –±–µ–∑–ø–µ—á–Ω–æ–≥–æ –∑'—î–¥–Ω–∞–Ω–Ω—è</p>
                <a href="{% url 'wireguard_management:create_config' %}" class="btn-primary">
                    –°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é
                </a>
            </div>
        {% endif %}
    </div>
    
    {% if user.is_superuser %}
    <!-- –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞ –ø–∞–Ω–µ–ª—å -->
    <div class="peers-section">
        <div class="section-title">
            <h2>üëë –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞ –ø–∞–Ω–µ–ª—å</h2>
            <a href="/admin/" class="btn-primary">üîß –ü–æ–≤–Ω–∞ –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</a>
        </div>
        
        <div class="quick-actions">
            <a href="/admin/accounts/customuser/" class="action-card">
                <span class="action-icon">üë•</span>
                <strong>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</strong><br>
                <small>–ö–µ—Ä—É–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏</small>
            </a>
            
            <a href="/admin/wireguard_management/wireguardnetwork/" class="action-card">
                <span class="action-icon">üåê</span>
                <strong>–ú–µ—Ä–µ–∂—ñ</strong><br>
                <small>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –º–µ—Ä–µ–∂</small>
            </a>
            
            <a href="/admin/wireguard_management/wireguardserver/" class="action-card">
                <span class="action-icon">üñ•Ô∏è</span>
                <strong>–°–µ—Ä–≤–µ—Ä–∏</strong><br>
                <small>–ö–µ—Ä—É–≤–∞–Ω–Ω—è —Å–µ—Ä–≤–µ—Ä–∞–º–∏</small>
            </a>
            
            <a href="/admin/wireguard_management/wireguardpeer/" class="action-card">
                <span class="action-icon">üîó</span>
                <strong>Peer'–∏</strong><br>
                <small>–í—Å—ñ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è</small>
            </a>
        </div>
        
        {% if all_peers %}
        <h3 style="margin-top: 30px;">üìà –û—Å—Ç–∞–Ω–Ω—ñ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è</h3>
        <table class="peers-table">
            <thead>
                <tr>
                    <th>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th>
                    <th>–ù–∞–∑–≤–∞</th>
                    <th>IP</th>
                    <th>–°–µ—Ä–≤–µ—Ä</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–¢—Ä–∞—Ñ—ñ–∫</th>
                </tr>
            </thead>
            <tbody>
                {% for peer in all_peers %}
                <tr>
                    <td><strong>{{ peer.user.username }}</strong></td>
                    <td>{{ peer.name }}</td>
                    <td><code>{{ peer.ip_address }}</code></td>
                    <td>{{ peer.server.name }}</td>
                    <td>
                        {% if peer.is_online %}
                            <span class="status-online">üü¢ –û–Ω–ª–∞–π–Ω</span>
                        {% else %}
                            <span class="status-offline">üî¥ –û—Ñ–ª–∞–π–Ω</span>
                        {% endif %}
                    </td>
                    <td class="traffic-stats">
                        {{ peer.get_sent_mb|add:peer.get_received_mb|floatformat:1 }} MB
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- QR Code Modal -->
<div id="qrModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 12px; text-align: center; max-width: 400px;">
        <h3 id="qrTitle">QR –∫–æ–¥ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó</h3>
        <div id="qrCode" style="margin: 20px 0;"></div>
        <button onclick="closeQRModal()" class="btn-primary">–ó–∞–∫—Ä–∏—Ç–∏</button>
    </div>
</div>

<script>
function showQRCode(peerId) {
    fetch(`{% url 'wireguard_management:qr_code' %}?peer_id=${peerId}`)
        .then(response => response.json())
        .then(data => {
            if (data.qr_code) {
                document.getElementById('qrTitle').textContent = `QR –∫–æ–¥: ${data.config_name}`;
                document.getElementById('qrCode').innerHTML = `<img src="${data.qr_code}" alt="QR Code" style="max-width: 300px;">`;
                document.getElementById('qrModal').style.display = 'block';
            } else {
                alert('–ü–æ–º–∏–ª–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó QR –∫–æ–¥—É');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è QR –∫–æ–¥—É');
        });
}

function closeQRModal() {
    document.getElementById('qrModal').style.display = 'none';
}

// –ê–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–æ–∂–Ω—ñ 30 —Å–µ–∫—É–Ω–¥
setInterval(() => {
    fetch('{% url "wireguard_management:connection_stats" %}')
        .then(response => response.json())
        .then(data => {
            // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ
            console.log('Stats updated:', data);
        })
        .catch(error => console.error('Error updating stats:', error));
}, 30000);
</script>
{% endblock %}
